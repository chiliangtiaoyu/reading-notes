## 优化器逻辑

优化器选择索引，主要目的是为了找到一个最优的执行方案，用最小的代价去执行语句，扫描行数是影响执行代价的条件之一，还有是否启动临时表，是否排序都会所为执行代价的条件，优化器会进行综合判断。

**扫描行数的估算**：是通过统计信息来估算记录数量的，**统计信息**其实就是索引上的**区分度**，一般来说索引区分度越高越好，而一个索引上不同的值就叫做“基数”。

而算出索引的基数是通过**采样统计**，主要就是读取索引的M页的数据算出不同值在**每页的平均数量*索引总页数**，得到一个估算值，当然也可以全部扫描得到准确的基数值，但是这是很浪费性能的。

当然这个采样统计值也不是一直不变的，当变更数量超过1/N的时候就会重新统计基数

**analyze table t** 可以重新统计索引信息

![img](https://static001.geekbang.org/resource/image/1e/1e/1e5ba1c2934d3b2c0d96b210a27e1a1e.png)

这张图因为sessionA还没有被提交所以insert不能占用delete的空间，导致统计信息出错

